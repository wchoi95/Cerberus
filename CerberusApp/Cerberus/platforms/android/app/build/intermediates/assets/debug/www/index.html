<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
        crossorigin="anonymous">

    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>

    <title>Cerberus</title>
    <style>
        .page-header {
            border-bottom-style: inset;
            border-bottom-width: 2px;
            padding-top: 5px;
        }

        .jumbotron {
            margin-top: 5px;
            background: rgb(107, 107, 107);
            border-left-style: solid;
            border-left-color: grey;
            border-left-width: 10px;
            color: white;

        }

        .btn {
            height: 60px;
        }

        #profileJumbotron {
            background: rgb(189, 199, 252);
            border-left-color: rgb(31, 56, 196);
            border-left-width: 10px;
            border-left-style: solid;
            padding: 20px;
            color: black;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="page-header">
            <h1>
                <center>Cerberus</center>
                <div id="testDiv">

                </div>
            </h1>
        </div>
        <div id="logInDiv">
            <form class="form-signin">
                <h2 class="form-signin-heading text-center">
                    <i>Please sign in</i>
                </h2>
                <label for="inputUsername" class="sr-only">Username</label>
                <input type="username" id="inputUsername" class="form-control" placeholder="Username" style="margin-bottom: 20px" required
                    autofocus>
                <label for="inputPassword" class="sr-only">Password</label>
                <input type="password" id="inputPassword" class="form-control" style="margin-bottom: 20px" placeholder="Password" required>
                <p class="text-center bg-warning" id="signInResult"></p>

                <div id="signInWrapper" class="wrapper text-center">
                    <div class="btn-group" role="group" aria-label="signInButtonGroup">
                        <button id="signInButton" class="btn btn-lg btn-primary" type="button">Sign in</button>
                        <button id="registerButton" class="btn btn-lg btn-primary" type="button">Register</button>
                    </div>
                </div>

            </form>
        </div>
        <div id="loggedInContent">
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="profile-tab" data-toggle="tab" href="#profile" role="tab" aria-controls="profile" aria-selected="false">Profile</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="contact-tab" data-toggle="tab" href="#contact" role="tab" aria-controls="contact" aria-selected="false">Chat</a>
                </li>
            </ul>
            <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                    <div class="jumbotron">
                        <p1>This application lets you control your security system remotely from your mobile device. Use the
                            interface below to unlock/lock your door or view a snapshot through your security camera.</p1>
                    </div>
                    <button type="button" id="lock" class="btn btn-primary btn-block">unlock</button>
                    <button type="button" id="snapshotButton" class="btn btn-primary btn-block" data-toggle="modal" data-target="#snapshotModal">snapshot</button>
                    <div class="modal fade" tabindex="-1" id="snapshotModal" role="dialog" aria-labelledby="snapshotModalLabel" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="snapshotModalTitle">Security Camera Snapshot</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <img class="center" id="snapshot" style="height:auto; width:auto; margin-left: auto; margin-right: auto; display: block;"></img>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                    <button type="button" id="refreshButton" class="btn btn-primary">Refresh</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                    <div class="jumbotron" id="profileJumbotron">
                        <h6 style="display:inline">Username: </h6>
                        <p1 id="username"></p1>
                        </p1>
                    </div>
                    <button type="button" id="signOutButton" class="btn btn-primary btn-block">logout</button>
                </div>
                <div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab">
                    <div class="jumbotron">
                        <p1>Use the chat box below to message whoever may be at your door.</p1>
                    </div>
                    <textarea readonly id="chatBox" class="form-control" rows="4" style="margin-bottom:20px"></textarea>
                    <textarea id="messageBox" class="form-control" rows="4" placeholder="Type your message here"></textarea>
                    <br>
                    <button type="button" id="sendMessageButton" class="btn btn-primary btn-block">send</button>

                </div>
            </div>
        </div>

    </div>

    <script type="text/javascript" src="cordova.js"></script>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->

    <script>
        function Main() {
            $.support.cors = true;
            $.mobile.allowCrossDomainPages = true;
        }

        var loggedIn = false;
        var lastMessage = ''; // Used to prevent duplicate messages sending.


        $(document).ready(function () {
            displayIfLogged();

            // Toggle the lock, update lock state.
            $('#lock').click(function () {
                setLockState(toggleLock());
            });

            // Changes lock button text and returns the lock state
            // after a toggle.
            function toggleLock() {
                if ($("#lock").text() == "unlock") {
                    $("#lock").text('lock');
                    return 0; // Current state is unlocked.
                }
                else {
                    $("#lock").text('unlock');
                    return 1; // Current state is locked.
                }
            }

            // Posts to the server to set the lock state.
            function setLockState(lockState) {
                $.ajax({
                    url: "http://38.88.74.71:80/lock",
                    type: "POST",
                    data: { message: lockState },
                    dataType: "text",
                });
            }

            // Queries the server for the current lock state.
            function getLockState() {
                $.get("http://38.88.74.71:80/lock", function (data) {
                    return data;
                });
            }

            // Updates the lock state. Setting the lock state using
            // the button should be allowed to work dispite this.
            function syncLock() {
                var isLocked = getLockState();
                if (isLocked == 1)
                    $("lock").text('unlock');
                else if (isLocked == 0)
                    $("#lock").text('lock');
            }

            // Attempt to sign in on button click.
            $("#signInButton").click(function () {
                signIn();
            });

            // Sign out on button click.
            $("#signOutButton").click(function () {
                signOut();
            });

            // Sign in to the application.
            function signIn() {
                var username = $("#inputUsername").val();
                var password = $("#inputPassword").val();

                $.when(attemptLogin(username, password)).done(function () {
                    displayIfLogged();
                    // console.log(loggedIn);
                    $("#inputUsername").val('');
                    $("#inputPassword").val('');
                });
                // console.log("just called attemptlogin");

            }

            function attemptLogin(username, password) {
                return $.get("http://38.88.74.71:80/login", { username: username, password: password },
                    function (data) {
                        if (data === "ERR: INVALID PASS") {
                            $("#signInResult").html("Incorect password.");
                        } else if (data === "ERR: NO USER") {
                            $("#signInResult").html("No user matches those credentials.");
                        } else {
                            loggedIn = true;
                            $("#signInResult").html("");
                            setProfileDetails(username);
                        }
                    });
            }

            // Sign out of the application.
            function signOut() {
                loggedIn = false;
                displayIfLogged();
            }

            // Check if logged in and display content accordingly.
            function displayIfLogged() {
                if (!loggedIn) {
                    document.getElementById("loggedInContent").style.display = "none";
                    document.getElementById("logInDiv").style.display = "block";
                }
                else {
                    document.getElementById("loggedInContent").style.display = "block";
                    document.getElementById("logInDiv").style.display = "none";
                }
            }


            // Set user profile details. Place holders.
            function setProfileDetails(username) {
                $('#username').html(username);
            }


            // Send the type messaged to the visitor as well as to the chat box.
            $("#sendMessageButton").click(function () {
                var message = $('#messageBox').val();
                sendMessage(message);
                $('#messageBox').val('');
            });

            // Send a message to be displayed on LCD.
            function sendMessage(message) {
                $.ajax({
                    url: "http://38.88.74.71:80/chat",
                    type: "POST",
                    data: { message: message },
                    dataType: "text",
                });

                $('#chatBox').html($('#chatBox').val() + 'Me: ' + message + '\n');
            }

            // Attempt to receive a message from the visitor.
            function receiveMessage() {
                $.get("http://38.88.74.71:80/chatget", function (data) {
                    displayMessage(data);
                });
            }

            // Display a message in the chat box.
            function displayMessage(data) {
                var IDIndex = data.indexOf(" ");

                // Only display a message if it isn't a recently sent duplicate.
                if (data != '' && lastMessage != data) {
                    $('#chatBox').html($('#chatBox').val() + 'Visitor: ' + data.substr(IDIndex + 1) + '\n');
                    lastMessage = data;
                }
            }

            // Retrieve image from the server and display it.
            function getImage() {
                $.ajax({
                    url: "http://38.88.74.71:80/image",
                    type: "GET",
                    headers: {
                        "Authorization": "Basic " + btoa("user:pw")
                    },
                    xhrFields: {
                        withCredentials: true
                    },
                    mimeType: "text/plain; charset=x-user-defined"
                }).done(function (data, textStatus, jqXHR) {
                    $("#snapshot").attr('src', 'data:image/jpeg;base64,' + (data));
                }).fail(function (jqXHR, textStatus, errorThrown) {
                    alert("fail: " + errorThrown);
                });
            }

            // Refresh the image from the webcam.
            $('#refreshButton').click(function () {
                getImage();
            });

            // Display the webcam image in the modal.
            $('#snapshotButton').click(function () {
                getImage();
            });


            setInterval(function () {
                // syncLock();
                receiveMessage();
            }, 50);

        });
    </script>
</body>

</html>